<div id="homies">
	<h1>Homies</h1>
	
	<p class="info" id="homies_help">Invite them to go out again by clicking on the envelope icon and sending a message.</p>
	
	<ul id="homies_list">
	</ul>
</div>

<div id="message_popup" style="display: none">
    <form action="#" method="post">
		<div id="message_label_container" for="message_input"><img id="user_picture"><label id="message_receiver"></label></div>
		<textarea id="message_input"></textarea>
		<input type="submit" value="Send" id="send_message" />
	</form>
    <script type="text/javascript">
        $("#send_message").click(function(evt) {
			$(".ui-dialog-titlebar-close").trigger("click");
			
			$("#homies .info").after('<p class="indication" style="display: none;">Message was sent!</p>');
			$(".indication").slideDown();
			
			return false;
        });
    </script>
</div>

<script>
String.prototype.capitalize = function() {
    return this.charAt(0).toUpperCase() + this.slice(1);
}

$.getJSON("users.json", function(data) {
    var anyHomies = false;
	for(var i=0; i<3; i++) {
		if ("homies" === $.cookie("homie"+i)) {
            anyHomies = true;
            var user = data[i][0].user;
            var username = user.name.first.capitalize() + " " +  user.name.last[0].capitalize() + ".";
            var html = $("<li></li>");
            var link = $("<a href='#' title='" + username + "' class='normal_text'></a>");

            link.append('<a href="javascript:void(0);" onclick="message(' + i + ')"><img src="images/envelope_white.png" alt="envelope" class="envelope" width="35" style="opacity: .1" />');	
            link.append("<img class='user_image' src='" + user.picture + "' alt='user' />");
            link.append("<p class='user_name'>" + username + "</p>");

            html.append(link);

            $("#homies_list").append(html);
        }
	}
    if (!anyHomies) {
        $("#homies_help").html('You have no homies! How about you head over to <a id="matches_link" href="?page=matches' + $.cookie("match_progress") + '">Get Matched</a> and meet some people?');
    }
});
    
var message = function(index) {
    $.getJSON("users.json", function(data) {
        var user = data[index][0].user;
        var username = user.name.first.capitalize() + " " +  user.name.last[0].capitalize() + ".";
		$("#message_receiver").text(username);
		$("#user_picture").attr("src", user.picture);
		$("#user_picture").attr("alt", username);
        $("#message_input").val("");
    });
    
    var popupHeight = 400;
    var offset = 50;
    var position = "center top+" + offset;
    $("#message_popup").dialog({
        height: "auto",
        width: 575,
        modal: true,
        dialogClass: "message_popup",
        draggable: false,
    }).parent()
    .position({
        my: "center top+" + offset,
        of: "#controls",
    });
}
</script>